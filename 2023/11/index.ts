import { sortBy, sum, uniq, uniqBy, uniqWith } from "lodash";

const input = `..............................................#......#...............................................#..........................#...........
.....#......................................................#.............................#.................................................
............#...................#........#....................................#..............................#...........#..................
...............................................................................................#............................................
.#....................#...........................#......................................................#...........#.....................#
............................................................................................................................................
...................................#.......................#...........................#....................................................
....#...................................................................#......#..................#.............#...................#.......
..............................................#.............................................................................................
...........#.............................#......................#...........................................................................
...................#.........#..............................................................................................#...............
.....................................................#.....................#...................#..........#...............................#.
...............#................................#.......................................................................#...................
....#..............................#......................................................#...........#..........................#..........
..............................................................#.............................................................................
...........................#.................#...............................................................#.....#..................#.....
.......#...........#..............................................................#.........................................................
..............#...........................................................................................................................#.
...............................#..................#.........................................................................................
..#............................................................................#............................................#...............
.........................#..........#.....................................#.................#...................#...........................
.................#......................................#............................#................................#................#....
.......................................................................................................#....................................
.....#................#........................................#............................................................................
........................................................................#................................................#..................
...........................................#...................................#..............................#.............................
..........................#..............................#..........................................................#.....................#.
..#............#......................................................................#..........................................#..........
................................................#..............................................#............................................
.......................................#..............................................................................................#.....
.....#......................#.................................#............................................................#................
................................................................................#..........................................................#
#.........#...........................................................................................#.....................................
.....................................................................................................................#...........#..........
...........................................................#..............................#.................................................
..............#.......#.........#........................................#...........................................................#......
......................................#.....#.....................#..........................................................#..............
...........................#............................#.........................................#......................................#..
...#...............#...........................................................#.....#..........................#...........................
...................................#........................................................................................................
............#....................................#.............#..........................................#..........#..............#.......
.......................#................................................................#...................................................
......#...............................#...............#.................................................................................#...
#..............#...........................#................................................................................................
............................#.............................#................................................................#................
..........#........#..............................................#...................#........#...............#............................
.......................................................................................................................#....................
.........................................#..............................#.....#.............................................................
.....................................................................................................................................#......
.....................................................#......................................................................................
........#.....#....................................................#..................................#.....................................
.....................#.........................#.......................................#...................................#................
...#.........................#..........................#..........................................................#............#...........
............................................................................................................................................
...........#...................................................#.............................#..............................................
..................#.........................................................................................#...............................
..........................#................................#..........................................#.....................................
................................#.....#...................................#............#....................................................
..............#............................#.......................#............#............................................#..............
.....#..................................................#.........................................#............#.....#.....................#
............................................................................................................................................
........................................#...............................................................#...................................
.....................................................#......#.................................#.............................................
..........#............................................................................................................#........#...........
............................................................................................................................................
.#................#.......#.......................#...................#.....#.........................#................................#....
...............................#..................................................#..............................#..........................
........#....................................#....................#......................#..................................................
............................................................................................................................................
.........................................................#...................................................#.........#....................
..............................................................#..............................................................#..............
......................................#...........#.........................#........................#................................#.....
.....................#......#...............#...............................................................................................
............#.......................................................................................................#...........#...........
...................................................................#......................................#...............................#.
...#................................#..........................................................................#............................
.........#.....................................................#............................................................................
..............................................................................#....................#........................................
.................#.....................................#.............................#.............................#....................#...
........................#......#.............#..............................................................................................
.....................................................................#.....................................#...............#................
............................................................................................................................................
#..............................................................................................#............................................
.................................#......................................#..............#....................................................
.................................................#.....................................................................................#....
...#...............#.....................#......................................#........................................#..................
........................#......................................#...........................................#.......................#........
....................................................#.....................#................#.........#......................................
............#...............................................................................................................................
...........................................................#.........................#.........................................#............
.....................................#............................#.........................................................................
......#.............................................................................................................#.......................
....................#...........#.............#...............#.........................#................................#...........#......
.........................................#.....................................#............................#...............................
...........#............................................#...................................................................................
.................................................................................................................................#..........
...#..............................................................#.............................#.................#.........#............#..
......................#..............................................................#................#................#....................
.........#.....................#......................................#.....................................................................
.........................................................................................#..................#...............................
.................#.........................#..............#...............................................................#.................
.....#...............................................#............................#.........................................................
....................................................................................................................#.......................
..........#..........#.......#................#......................#........#............#.......#........................................
...................................#.....#..................................................................................................
.............................................................#.........................#.........................#......#...................
.........................................................................#.......#.......................#........................#.........
.......................#.........................................................................#...........................#..............
........#.........#.........#...................#...........................................................................................
#.........................................................#............................................................................#....
........................................................................................#............#......................................
..................................#........................................................................................................#
..............#.....#.....................#..............................#.......................................#..........................
...#..........................................................#.............................................................................
.........#.......................................#............................#...............#..........................#........#.........
...........................#.................................................................................#..............................
.........................................................................................#...........................#......................
.....................................................................#.................................................................#....
.....#..................#.......#.........#.................#................................................................#..............
.....................................#................#....................................................#.......................#........
...............................................#............................................................................................
...........#........#.......#...................................................#...........................................................
................................................................#...........................................................................
................#............................................................................#..............................................
#......................#...............................................................................................#....................
.................................#...............................................................................#............#..........#..
.....#..........................................#..........#..........................................#.....................................
...........................................#...................................#.................#..........................................
..........#.......#...........#...............................................................................#.............................
.......................................#............................................................................................#.......
...................................................#.....................................................................#..................
#......................#........................................#..........................#...............#................................
.............................................................................................................................#..............
.............................................#.........................#..............#.....................................................
.......#.............................................#.......#...................................................................#..........
............#.....#.....................#..............................................................#............#.....#.................
...#.........................#................................................................................#.............................
...............................................#..................#.........................................................................
...................................#....................................#.......#........#.........#..........................#.............
..........#.....#......................................................................................................#..............#.....`;
const testInput = `...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....`;

const lines = input.split("\n").map((line) => [...line]);

const stellarObjects: StellarObject[] = lines
  .map((line, lineIndex) =>
    line.map((char, rowIndex) => ({ lineIndex, rowIndex, char }))
  )
  .flat();

const rows = new Array(lines[0].length)
  .fill(0)
  .map((_, index) => lines.map((line) => line[index]));

const computeDistanceValueByRow = (emptyRowValue: number, rowIndex: number) => {
  const map = Object.fromEntries(
    rows
      .map((row, index) => ({
        isEmpty: row.every((char) => char === "."),
        index,
      }))
      .map(({ index, isEmpty }) => [index, isEmpty ? emptyRowValue : 1])
  );

  const value = map[rowIndex];

  if (!value) {
    throw Error(`no value found for row ${rowIndex}`);
  }

  return value;
};

const computeDistanceValueByLine = (emptyLineValue: number) =>
  Object.fromEntries(
    lines
      .map((line, index) => ({
        isEmpty: line.every((char) => char === "."),
        index,
      }))
      .map(({ index, isEmpty }) => [index, isEmpty ? emptyLineValue : 1])
  );

type Point = {
  lineIndex: number;
  rowIndex: number;
};

const format = (p: Point) => `y:${p.rowIndex},x:${p.lineIndex}`;

type StellarObject = Point & { char: string };

const modifiedManhattanDistance =
  (emptyLineDistanceValue: number) => (point1: Point, point2: Point) => {
    const [smallestPointRowIndex, largestPointRowIndex] = [
      point1.rowIndex,
      point2.rowIndex,
    ].toSorted((a, b) => a - b);

    const rowsBetweenThePoints = rows
      .map((row, index) => ({ row, index }))
      .slice(smallestPointRowIndex + 1, largestPointRowIndex + 1);
    const horizontalDistance = sum(
      rowsBetweenThePoints.map(({ index }) =>
        computeDistanceValueByRow(emptyLineDistanceValue, index)
      )
    );

    const [smallestPointLineIndex, largestPointLineIndex] = [
      point1.lineIndex,
      point2.lineIndex,
    ].toSorted((a, b) => a - b);

    const linesBetweenThePoints = lines
      .map((line, index) => ({ line, index }))
      .slice(smallestPointLineIndex + 1, largestPointLineIndex + 1);

    const verticalDistance = sum(
      linesBetweenThePoints.map(
        ({ index }) => computeDistanceValueByLine(emptyLineDistanceValue)[index]
      )
    );

    // console.log(
    //   format(point1),
    //   format(point2),
    //   linesBetweenThePoints.map((line) => line.index),
    //   rowsBetweenThePoints.map((line) => line.index),
    //   linesBetweenThePoints.length + rowsBetweenThePoints.length,
    //   horizontalDistance + verticalDistance
    // );

    return verticalDistance + horizontalDistance;
  };

const allGalaxies = stellarObjects.filter(({ char }) => char === "#");

const isSamePoint = (point1: Point, point2) =>
  point1.rowIndex === point2.rowIndex && point1.lineIndex === point2.lineIndex;

const coupleId = (point1: Point, point2: Point): string =>
  sortBy(
    [point1, point2],
    (p) => p.lineIndex,
    (p) => p.rowIndex
  )
    .map(format)
    .join("-");

const isSameCouple =
  (point1Couple1: Point, point2Couple1: Point) =>
  (point1Couple2: Point, point2Couple2: Point) =>
    (isSamePoint(point1Couple1, point1Couple2) &&
      isSamePoint(point2Couple1, point2Couple2)) ||
    (isSamePoint(point2Couple1, point1Couple2) &&
      isSamePoint(point1Couple1, point2Couple2));

const allCombinations = allGalaxies
  .map((galaxy) => allGalaxies.map((g) => [galaxy, g] as const))
  .flat()
  .filter(([g1, g2]) => !isSamePoint(g1, g2));

const allUniqueCombinations = uniqBy(allCombinations, ([c1, c2]) =>
  coupleId(c1, c2)
);

console.log(allGalaxies.length);
console.log(allCombinations.length);
console.log(allUniqueCombinations.length);

const sumOfDistancesPartI = sum(
  allUniqueCombinations.map(([galaxy1, galaxy2]) =>
    modifiedManhattanDistance(2)(galaxy1, galaxy2)
  )
);

console.log(sumOfDistancesPartI);

// PART II
const sumOfDistancesPartII = sum(
  allUniqueCombinations.map(([galaxy1, galaxy2]) =>
    modifiedManhattanDistance(1_000_000)(galaxy1, galaxy2)
  )
);

console.log(sumOfDistancesPartII);
