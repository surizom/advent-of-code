import { sum, uniqBy, uniqWith } from "lodash";

const input = `..............................................#......#...............................................#..........................#...........
.....#......................................................#.............................#.................................................
............#...................#........#....................................#..............................#...........#..................
...............................................................................................#............................................
.#....................#...........................#......................................................#...........#.....................#
............................................................................................................................................
...................................#.......................#...........................#....................................................
....#...................................................................#......#..................#.............#...................#.......
..............................................#.............................................................................................
...........#.............................#......................#...........................................................................
...................#.........#..............................................................................................#...............
.....................................................#.....................#...................#..........#...............................#.
...............#................................#.......................................................................#...................
....#..............................#......................................................#...........#..........................#..........
..............................................................#.............................................................................
...........................#.................#...............................................................#.....#..................#.....
.......#...........#..............................................................#.........................................................
..............#...........................................................................................................................#.
...............................#..................#.........................................................................................
..#............................................................................#............................................#...............
.........................#..........#.....................................#.................#...................#...........................
.................#......................................#............................#................................#................#....
.......................................................................................................#....................................
.....#................#........................................#............................................................................
........................................................................#................................................#..................
...........................................#...................................#..............................#.............................
..........................#..............................#..........................................................#.....................#.
..#............#......................................................................#..........................................#..........
................................................#..............................................#............................................
.......................................#..............................................................................................#.....
.....#......................#.................................#............................................................#................
................................................................................#..........................................................#
#.........#...........................................................................................#.....................................
.....................................................................................................................#...........#..........
...........................................................#..............................#.................................................
..............#.......#.........#........................................#...........................................................#......
......................................#.....#.....................#..........................................................#..............
...........................#............................#.........................................#......................................#..
...#...............#...........................................................#.....#..........................#...........................
...................................#........................................................................................................
............#....................................#.............#..........................................#..........#..............#.......
.......................#................................................................#...................................................
......#...............................#...............#.................................................................................#...
#..............#...........................#................................................................................................
............................#.............................#................................................................#................
..........#........#..............................................#...................#........#...............#............................
.......................................................................................................................#....................
.........................................#..............................#.....#.............................................................
.....................................................................................................................................#......
.....................................................#......................................................................................
........#.....#....................................................#..................................#.....................................
.....................#.........................#.......................................#...................................#................
...#.........................#..........................#..........................................................#............#...........
............................................................................................................................................
...........#...................................................#.............................#..............................................
..................#.........................................................................................#...............................
..........................#................................#..........................................#.....................................
................................#.....#...................................#............#....................................................
..............#............................#.......................#............#............................................#..............
.....#..................................................#.........................................#............#.....#.....................#
............................................................................................................................................
........................................#...............................................................#...................................
.....................................................#......#.................................#.............................................
..........#............................................................................................................#........#...........
............................................................................................................................................
.#................#.......#.......................#...................#.....#.........................#................................#....
...............................#..................................................#..............................#..........................
........#....................................#....................#......................#..................................................
............................................................................................................................................
.........................................................#...................................................#.........#....................
..............................................................#..............................................................#..............
......................................#...........#.........................#........................#................................#.....
.....................#......#...............#...............................................................................................
............#.......................................................................................................#...........#...........
...................................................................#......................................#...............................#.
...#................................#..........................................................................#............................
.........#.....................................................#............................................................................
..............................................................................#....................#........................................
.................#.....................................#.............................#.............................#....................#...
........................#......#.............#..............................................................................................
.....................................................................#.....................................#...............#................
............................................................................................................................................
#..............................................................................................#............................................
.................................#......................................#..............#....................................................
.................................................#.....................................................................................#....
...#...............#.....................#......................................#........................................#..................
........................#......................................#...........................................#.......................#........
....................................................#.....................#................#.........#......................................
............#...............................................................................................................................
...........................................................#.........................#.........................................#............
.....................................#............................#.........................................................................
......#.............................................................................................................#.......................
....................#...........#.............#...............#.........................#................................#...........#......
.........................................#.....................................#............................#...............................
...........#............................................#...................................................................................
.................................................................................................................................#..........
...#..............................................................#.............................#.................#.........#............#..
......................#..............................................................#................#................#....................
.........#.....................#......................................#.....................................................................
.........................................................................................#..................#...............................
.................#.........................#..............#...............................................................#.................
.....#...............................................#............................#.........................................................
....................................................................................................................#.......................
..........#..........#.......#................#......................#........#............#.......#........................................
...................................#.....#..................................................................................................
.............................................................#.........................#.........................#......#...................
.........................................................................#.......#.......................#........................#.........
.......................#.........................................................................#...........................#..............
........#.........#.........#...................#...........................................................................................
#.........................................................#............................................................................#....
........................................................................................#............#......................................
..................................#........................................................................................................#
..............#.....#.....................#..............................#.......................................#..........................
...#..........................................................#.............................................................................
.........#.......................................#............................#...............#..........................#........#.........
...........................#.................................................................................#..............................
.........................................................................................#...........................#......................
.....................................................................#.................................................................#....
.....#..................#.......#.........#.................#................................................................#..............
.....................................#................#....................................................#.......................#........
...............................................#............................................................................................
...........#........#.......#...................................................#...........................................................
................................................................#...........................................................................
................#............................................................................#..............................................
#......................#...............................................................................................#....................
.................................#...............................................................................#............#..........#..
.....#..........................................#..........#..........................................#.....................................
...........................................#...................................#.................#..........................................
..........#.......#...........#...............................................................................#.............................
.......................................#............................................................................................#.......
...................................................#.....................................................................#..................
#......................#........................................#..........................#...............#................................
.............................................................................................................................#..............
.............................................#.........................#..............#.....................................................
.......#.............................................#.......#...................................................................#..........
............#.....#.....................#..............................................................#............#.....#.................
...#.........................#................................................................................#.............................
...............................................#..................#.........................................................................
...................................#....................................#.......#........#.........#..........................#.............
..........#.....#......................................................................................................#..............#.....`;

const lines = input.split("\n").map((line) => [...line]);

const stellarObjects: StellarObject[] = lines
  .map((line, lineIndex) =>
    line.map((char, rowIndex) => ({ lineIndex, rowIndex, char }))
  )
  .flat();

const rows = new Array(lines[0].length)
  .fill(0)
  .map((_, index) => lines.map((line) => line[index]));

const computeDistanceValueByRow = (emptyRowValue: number) =>
  Object.fromEntries(
    rows
      .map((row, index) => ({
        isEmpty: row.every((char) => char === "."),
        index,
      }))
      .map(({ index, isEmpty }) => [index, isEmpty ? emptyRowValue : 1])
  );

const computeDistanceValueByLine = (emptyLineValue: number) =>
  Object.fromEntries(
    lines
      .map((line, index) => ({
        isEmpty: line.every((char) => char === "."),
        index,
      }))
      .map(({ index, isEmpty }) => [index, isEmpty ? emptyLineValue : 1])
  );

type Point = {
  lineIndex: number;
  rowIndex: number;
};

type StellarObject = Point & { char: string };

const modifiedManhattanDistance =
  (emptyLineDistanceValue: number) => (point1: Point, point2: Point) => {
    const [smallestPointRowIndex, largestPointRowIndex] = [
      point1.rowIndex,
      point2.rowIndex,
    ].sort();

    const rowsBetweenThePoints = rows
      .map((row, index) => ({ row, index }))
      .filter(
        ({ index }) =>
          index > smallestPointRowIndex && index <= largestPointRowIndex
      );

    const horizontalDistance = sum(
      rowsBetweenThePoints.map(
        ({ index }) => computeDistanceValueByRow(emptyLineDistanceValue)[index]
      )
    );

    const [smallestPointLineIndex, largestPointLineIndex] = [
      point1.lineIndex,
      point2.lineIndex,
    ].sort();

    const linesBetweenThePoints = lines
      .map((line, index) => ({ line, index }))
      .filter(
        ({ index }) =>
          index > smallestPointLineIndex && index <= largestPointLineIndex
      );

    const verticalDistance = sum(
      linesBetweenThePoints.map(
        ({ index }) => computeDistanceValueByLine(emptyLineDistanceValue)[index]
      )
    );

    return verticalDistance + horizontalDistance;
  };

const allGalaxies = stellarObjects.filter(({ char }) => char === "#");

const isSamePoint = (point1: Point, point2) =>
  point1.rowIndex === point2.rowIndex && point1.lineIndex === point1.lineIndex;

const isSameCouple =
  (point1Couple1: Point, point2Couple1: Point) =>
  (point1Couple2: Point, point2Couple2: Point) =>
    (isSamePoint(point1Couple1, point1Couple2) &&
      isSamePoint(point2Couple1, point2Couple2)) ||
    (isSamePoint(point2Couple1, point1Couple2) &&
      isSamePoint(point1Couple1, point2Couple2));

const allCombinations = allGalaxies
  .map((galaxy) =>
    allGalaxies
      .filter((g) => !isSamePoint(g, galaxy))
      .map((g) => [galaxy, g] as const)
  )
  .flat();

const allUniqueCombinations = uniqWith(
  allCombinations,
  ([point1Couple1, point2Couple1], [point1Couple2, point2Couple2]) =>
    isSameCouple(point1Couple1, point2Couple1)(point1Couple2, point2Couple2)
);

console.log(allGalaxies.length);
console.log(allCombinations.length);
console.log(allUniqueCombinations.length);

const sumOfDistancesPartI = sum(
  allUniqueCombinations.map(([galaxy1, galaxy2]) =>
    modifiedManhattanDistance(2)(galaxy1, galaxy2)
  )
);

console.log(sumOfDistancesPartI);

// PART II
const sumOfDistancesPartII = sum(
  allUniqueCombinations.map(([galaxy1, galaxy2]) =>
    modifiedManhattanDistance(1_000_000)(galaxy1, galaxy2)
  )
);

console.log(sumOfDistancesPartII);
